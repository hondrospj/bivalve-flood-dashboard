<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bivalve, NJ — Tidal Flooding Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1220; --text:#eaf0ff; --muted:#a9b6d3; --line:rgba(255,255,255,.085);
      --ok:#2dd4bf; --minor:#fbbf24; --moderate:#fb7185; --major:#a78bfa;
      --shadow:0 22px 70px rgba(0,0,0,.40); --radius:18px;
      --card:linear-gradient(180deg, rgba(255,255,255,.055), rgba(255,255,255,.025));
      --card2:rgba(0,0,0,.18);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:
        radial-gradient(1200px 650px at 15% -10%, rgba(34,211,238,.18), transparent 55%),
        radial-gradient(1000px 600px at 92% 12%, rgba(167,139,250,.16), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:16px 16px 28px}
    a{color:inherit;text-decoration:none}

    .banner{
      display:none;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(251,113,133,.12);
      border-radius:14px;
      padding:12px 12px;
      margin-bottom:12px;
      box-shadow:var(--shadow);
    }
    .banner b{font-weight:950}
    .banner .small{color:var(--muted);font-size:12.5px;margin-top:4px;line-height:1.25}
    .banner a{opacity:.9;text-decoration:underline;text-underline-offset:3px}

    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{width:44px;height:44px;border-radius:12px;border:1px solid var(--line);background:rgba(0,0,0,.25)}
    .brandTitle{display:flex;flex-direction:column;line-height:1.1}
    .kicker{color:var(--muted);font-weight:850;font-size:12px;letter-spacing:.2px;text-transform:uppercase}
    .name{font-size:18px;font-weight:950;letter-spacing:.2px}

    .statusPill{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:999px;
      border:1px solid var(--line);background:rgba(0,0,0,.16);
      box-shadow:var(--shadow);
      font-weight:950;font-size:12.5px;white-space:nowrap;
    }
    .dot{width:9px;height:9px;border-radius:999px;background:var(--ok);box-shadow:0 0 0 4px rgba(45,212,191,.16)}

    .grid{display:grid;grid-template-columns:1.15fr .85fr;gap:14px;margin-top:10px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      overflow:hidden;
      position:relative;
    }
    .card:before{
      content:"";position:absolute;inset:-1px;pointer-events:none;opacity:.9;
      background:
        radial-gradient(650px 280px at 16% 0%, rgba(45,212,191,.12), transparent 55%),
        radial-gradient(520px 320px at 90% 18%, rgba(251,113,133,.10), transparent 60%);
    }
    .card>*{position:relative}

    .hrow{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:10px}
    .hrow h2{
      margin:0;font-size:12.5px;letter-spacing:.22px;text-transform:uppercase;color:var(--muted);font-weight:950
    }

    .metrics{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
    @media(max-width:720px){.metrics{grid-template-columns:1fr}}
    .metric{background:var(--card2);border:1px solid var(--line);border-radius:14px;padding:12px;min-height:88px}
    .ml{color:var(--muted);font-weight:950;font-size:11.5px;text-transform:uppercase;letter-spacing:.2px;margin-bottom:8px}
    .mv{display:flex;align-items:baseline;gap:8px;font-weight:950;font-size:28px;letter-spacing:.2px}
    .unit{color:var(--muted);font-size:12px;font-weight:950}
    .ms{margin-top:6px;color:var(--muted);font-size:12.5px;line-height:1.25}

    .stages{
      display:grid;grid-template-columns:repeat(3, minmax(220px,1fr));
      gap:10px;overflow-x:auto;padding-bottom:2px;-webkit-overflow-scrolling:touch;margin-top:8px
    }
    @media(max-width:760px){.stages{grid-template-columns:1fr;overflow-x:visible}}
    .stage{background:var(--card2);border:1px solid var(--line);border-radius:14px;padding:14px;display:flex;align-items:center;justify-content:space-between;gap:10px;min-width:220px}
    .stageName{font-weight:950;font-size:20px;letter-spacing:.2px;white-space:nowrap}
    .badge{font-weight:950;font-size:13px;padding:10px 14px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.06);white-space:nowrap}

    .table{border-radius:14px;overflow:hidden;border:1px solid var(--line);background:var(--card2)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 10px;border-bottom:1px solid var(--line);font-size:13px}
    th{text-align:left;color:var(--muted);text-transform:uppercase;letter-spacing:.2px;font-size:11px;font-weight:950}
    tr:last-child td{border-bottom:none}

    .tag{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.05);font-weight:950;font-size:12px;white-space:nowrap}
    .chip{width:9px;height:9px;border-radius:99px;display:inline-block}

    .chartWrapTall{height:320px;width:100%}
    .chartWrap{height:270px;width:100%}
    .foot{margin-top:10px;color:var(--muted);font-size:12.5px;line-height:1.25}

    .filterRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    .input,.btn,select{
      background:rgba(0,0,0,.18);border:1px solid var(--line);color:var(--text);
      border-radius:12px;padding:10px 10px;font-weight:950;font-size:13px;outline:none
    }
    .input{min-width:240px}
    .btn{cursor:pointer}
    .btn:hover{filter:brightness(1.06)}
    .hint{color:var(--muted);font-size:12.5px;line-height:1.25}

    .miniPill{
      display:none;
      margin-left:10px;
      align-items:center;gap:10px;
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--line);background:rgba(0,0,0,.14);
      font-weight:950;font-size:12.5px;
      max-width:min(560px, 92vw);
    }
    .miniPill span{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  </style>
</head>

<body>
  <div class="wrap">

    <div class="banner" id="alertBanner">
      <div><b id="alertTitle">Coastal Flood Alert</b></div>
      <div class="small">
        <span id="alertBody"></span>
        <span id="alertLinkWrap" style="display:none"> · <a id="alertLink" target="_blank" rel="noopener">Details</a></span>
      </div>
    </div>

    <div class="top">
      <a class="brand" href="https://cupajoe.live/" target="_blank" rel="noopener">
        <img src="assets/cupajoe-logo.png" alt="Cupajoe logo">
        <div class="brandTitle">
          <div class="kicker" id="siteKicker">USGS 01412150 · Maurice River at Bivalve, NJ</div>
          <div class="name">Bivalve Tidal Flooding Dashboard</div>
        </div>
      </a>

      <div style="display:flex;align-items:center;justify-content:flex-end;gap:10px;flex-wrap:wrap">
        <div class="miniPill" id="nearPill" title="Last time within ±0.2 ft when at/above moderate">
          <span class="chip" id="nearChip" style="background:var(--moderate)"></span>
          <span id="nearText">—</span>
        </div>

        <div class="statusPill" id="stagePill">
          <span class="dot" id="stageDot"></span>
          <span id="stageText">Loading…</span>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="hrow">
          <h2>Live conditions</h2>
          <div id="statusText" class="kicker" style="text-transform:none">—</div>
        </div>

        <div class="metrics">
          <div class="metric">
            <div class="ml">Current water elevation</div>
            <div class="mv"><span id="curFt">—</span><span class="unit">ft</span></div>
            <div class="ms" id="curMeta">Updated: —</div>
          </div>

          <div class="metric">
            <div class="ml">Monthly maximum (this month)</div>
            <div class="mv"><span id="monMaxFt">—</span><span class="unit">ft</span></div>
            <div class="ms" id="monMaxMeta">—</div>
          </div>

          <div class="metric">
            <div class="ml">Daily maximum (today)</div>
            <div class="mv"><span id="dayMaxFt">—</span><span class="unit">ft</span></div>
            <div class="ms" id="dayMaxMeta">—</div>
          </div>

          <div class="metric">
            <div class="ml">Daily minimum (today)</div>
            <div class="mv"><span id="dayMinFt">—</span><span class="unit">ft</span></div>
            <div class="ms" id="dayMinMeta">—</div>
          </div>
        </div>

        <div class="stages" aria-label="Flood stages">
          <div class="stage">
            <div class="stageName">Minor</div>
            <div class="badge" id="minorBadge" style="color:var(--minor)">—</div>
          </div>
          <div class="stage">
            <div class="stageName">Moderate</div>
            <div class="badge" id="moderateBadge" style="color:var(--moderate)">—</div>
          </div>
          <div class="stage">
            <div class="stageName">Major</div>
            <div class="badge" id="majorBadge" style="color:var(--major)">—</div>
          </div>
        </div>

        <div class="foot" id="tsNote">—</div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="hrow">
          <h2>Top ten highest tides</h2>
        </div>

        <div class="table">
          <table aria-label="Top ten highest tides">
            <thead>
              <tr>
                <th>Rank</th>
                <th>Date</th>
                <th>Height (ft)</th>
                <th>Type</th>
              </tr>
            </thead>
            <tbody id="topTenBody"></tbody>
          </table>
        </div>

        <div style="height:12px"></div>

        <div class="hrow">
          <h2>Annual tidal flooding counts (2000–2025)</h2>
        </div>
        <div class="chartWrap"><canvas id="annualChart"></canvas></div>
      </div>
    </div>

    <div style="height:14px"></div>

    <div class="card">
      <div class="hrow">
        <h2>72 hours: observations vs NOAA Cape May predictions</h2>
        <div class="kicker" id="tsKicker" style="text-transform:none">Observed: USGS 15-min · Predicted: NOAA CO-OPS</div>
      </div>
      <div class="chartWrapTall"><canvas id="tsChart"></canvas></div>
      <div class="foot" id="fcNote">—</div>
    </div>

    <div style="height:14px"></div>

    <div class="card">
      <div class="hrow">
        <h2>Historic tides filter (above minor)</h2>
      </div>

      <div class="filterRow">
        <input class="input" id="minElev" type="number" step="0.01" value="4.19" />
        <select id="sortMode">
          <option value="desc">Highest first</option>
          <option value="asc">Lowest first</option>
          <option value="recent">Most recent</option>
        </select>
        <button class="btn" id="applyBtn">Apply</button>
        <button class="btn" id="resetBtn">Reset</button>
      </div>

      <div class="hint" id="histMeta">Loading…</div>

      <div style="height:10px"></div>

      <div class="table">
        <table aria-label="Historic tides above threshold">
          <thead>
            <tr>
              <th>Date/Time</th>
              <th>Peak (ft)</th>
              <th>Type</th>
            </tr>
          </thead>
          <tbody id="histBody"></tbody>
        </table>
      </div>
    </div>

  </div>

<script>
/* =========================
   CONFIG
========================= */
const TZ="America/New_York";
const USGS_SITE="01412150";
const PRIMARY_PARAM="72279";   // tidal elevation (NOS-averaged) if available at your site
const FALLBACK_PARAM="00065";  // gage height fallback

// Flood thresholds (ft)
const THRESH={minorLow:4.19, moderateLow:5.19, majorLow:6.19};

// NWS banner query point (near Bivalve)
const ALERT_POINT={lat:39.2325, lon:-75.0380};

// NOAA Cape May predictions
const NOAA_STATION="8536110";
const NOAA_DATUM="NAVD"; // if the API rejects NAVD for predictions, change to "MLLW" (or remove datum below)

// Repo JSON paths
const TOP_TEN_JSON="data/top_ten.json";
const ANNUAL_COUNTS_JSON="data/annual_counts.json";
const HIGH_TIDES_INDEX_JSON="data/high_tides_index.json";

/* =========================
   DOM
========================= */
const $=id=>document.getElementById(id);
const curFtEl=$("curFt"), curMetaEl=$("curMeta");
const monMaxFtEl=$("monMaxFt"), monMaxMetaEl=$("monMaxMeta");
const dayMaxFtEl=$("dayMaxFt"), dayMaxMetaEl=$("dayMaxMeta");
const dayMinFtEl=$("dayMinFt"), dayMinMetaEl=$("dayMinMeta");
const stageTextEl=$("stageText"), stageDotEl=$("stageDot");
const statusText=$("statusText");
const nearPill=$("nearPill"), nearText=$("nearText"), nearChip=$("nearChip");
const alertBanner=$("alertBanner"), alertTitle=$("alertTitle"), alertBody=$("alertBody"), alertLink=$("alertLink"), alertLinkWrap=$("alertLinkWrap");
const topTenBody=$("topTenBody");
const tsNote=$("tsNote"), fcNote=$("fcNote");
const histBody=$("histBody"), histMeta=$("histMeta");
const minElevEl=$("minElev"), sortModeEl=$("sortMode");

/* =========================
   Helpers
========================= */
const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
const isNum=v=>Number.isFinite(v);

function fmtNY(iso){
  try{
    const d=new Date(iso);
    return new Intl.DateTimeFormat("en-US",{timeZone:TZ,year:"numeric",month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(d);
  }catch{return iso;}
}
function getNYParts(date=new Date()){
  const p=new Intl.DateTimeFormat("en-US",{timeZone:TZ,year:"numeric",month:"2-digit",day:"2-digit"}).formatToParts(date);
  return {y:+(p.find(x=>x.type==="year")?.value||0), m:+(p.find(x=>x.type==="month")?.value||0), d:+(p.find(x=>x.type==="day")?.value||0)};
}
function startOfTodayNY_ISO(){
  const {y,m,d}=getNYParts(new Date());
  return new Date(Date.UTC(y,m-1,d,0,0,0)).toISOString();
}
function startOfMonthNY_ISO(){
  const {y,m}=getNYParts(new Date());
  return new Date(Date.UTC(y,m-1,1,0,0,0)).toISOString();
}
function nowISO(){ return new Date().toISOString(); }
function ymd(d){ return d.toISOString().slice(0,10).replaceAll("-",""); }

function classify(ft){
  if(ft>=THRESH.majorLow) return {label:"MAJOR FLOODING", color:"var(--major)", glow:"rgba(167,139,250,.22)", short:"Major"};
  if(ft>=THRESH.moderateLow) return {label:"MODERATE FLOODING", color:"var(--moderate)", glow:"rgba(251,113,133,.22)", short:"Moderate"};
  if(ft>=THRESH.minorLow) return {label:"MINOR FLOODING", color:"var(--minor)", glow:"rgba(251,191,36,.22)", short:"Minor"};
  return {label:"BELOW FLOOD STAGE", color:"var(--ok)", glow:"rgba(45,212,191,.18)", short:"Below"};
}
function stageTag(ft){ const c=classify(ft); return {txt:c.short, c:c.color}; }
function maxPoint(arr){ return arr.reduce((a,b)=>b.ft>a.ft?b:a, arr[0]); }
function minPoint(arr){ return arr.reduce((a,b)=>b.ft<a.ft?b:a, arr[0]); }

/* =========================
   Fetch helpers
========================= */
async function loadJSON(path){
  const res=await fetch(path,{cache:"no-store"});
  if(!res.ok) throw new Error("fetch "+path+" "+res.status);
  return res.json();
}
async function fetchJSON(url){
  const res=await fetch(url,{cache:"no-store"});
  if(!res.ok) throw new Error("fetch "+url+" "+res.status);
  return res.json();
}

/* =========================
   USGS IV
========================= */
async function fetchIV({startISO=null,endISO=null,parameterCd=PRIMARY_PARAM,period=null}={}){
  const url=new URL("https://waterservices.usgs.gov/nwis/iv/");
  url.searchParams.set("format","json");
  url.searchParams.set("sites",USGS_SITE);
  url.searchParams.set("parameterCd",parameterCd);
  url.searchParams.set("siteStatus","all");
  url.searchParams.set("agencyCd","USGS");
  if(period) url.searchParams.set("period",period);
  if(startISO) url.searchParams.set("startDT",startISO);
  if(endISO) url.searchParams.set("endDT",endISO);
  const j=await fetchJSON(url.toString());
  const ts=j?.value?.timeSeries?.[0];
  const vals=ts?.values?.[0]?.value||[];
  return vals.map(v=>({t:v.dateTime, ft:+v.value})).filter(p=>isNum(p.ft));
}
async function fetchWithFallback(opts){
  let s=await fetchIV({...opts,parameterCd:PRIMARY_PARAM});
  if(s.length) return s;
  return fetchIV({...opts,parameterCd:FALLBACK_PARAM});
}

/* =========================
   NOAA CO-OPS predictions (Cape May)
========================= */
async function fetchNOAA72h(){
  const now=new Date();
  const end=new Date(now.getTime()+72*3600*1000);
  const base="https://api.tidesandcurrents.noaa.gov/api/prod/datagetter";
  const qs=new URLSearchParams({
    product:"predictions",
    application:"cupajoe",
    station:NOAA_STATION,
    begin_date:ymd(now),
    end_date:ymd(end),
    time_zone:"gmt",
    units:"english",
    interval:"6",
    format:"json"
  });
  // datum for predictions is station-dependent; keep it here, easy to change
  if(NOAA_DATUM) qs.set("datum", NOAA_DATUM);
  const j=await fetchJSON(base+"?"+qs.toString());
  const p=(j?.predictions||[]).map(r=>({t:r.t.replace(" ","T")+"Z", ft:+r.v})).filter(x=>isNum(x.ft));
  return p;
}

/* =========================
   NWS coastal flood banner
========================= */
async function updateAlerts(){
  try{
    const url=`https://api.weather.gov/alerts/active?point=${ALERT_POINT.lat},${ALERT_POINT.lon}`;
    const j=await fetchJSON(url);
    const feats=j?.features||[];
    const coastal=feats.find(f=>((f?.properties?.event||"").toLowerCase().includes("coastal flood")));
    if(!coastal){ alertBanner.style.display="none"; return; }
    const p=coastal.properties||{};
    alertTitle.textContent=p.event||"Coastal Flood Alert";
    const ends=p.ends?fmtNY(p.ends):(p.expires?fmtNY(p.expires):"—");
    alertBody.textContent=(p.headline?p.headline+" · ":"")+"Ends: "+ends;
    const link=p.web||p.uri||p.id;
    if(link){ alertLink.href=link; alertLinkWrap.style.display="inline"; }
    else alertLinkWrap.style.display="none";
    alertBanner.style.display="block";
  }catch{ alertBanner.style.display="none"; }
}

/* =========================
   Render: Top Ten + Annual
========================= */
function renderTopTen(rows){
  topTenBody.innerHTML="";
  rows.forEach((r,i)=>{
    const ft=+r.ft;
    const t=stageTag(ft);
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><b>#${r.rank ?? (i+1)}</b></td>
      <td>${r.date}</td>
      <td><b>${ft.toFixed(2)}</b></td>
      <td><span class="tag"><span class="chip" style="background:${t.c}"></span>${t.txt}</span></td>
    `;
    topTenBody.appendChild(tr);
  });
}

let annualChart=null;
function renderAnnualChart(rows){
  const years=rows.map(r=>r.year);
  const minor=rows.map(r=>+r.minor||0);
  const moderate=rows.map(r=>+r.moderate||0);
  const major=rows.map(r=>+r.major||0);

  if(annualChart) annualChart.destroy();
  annualChart=new Chart($("annualChart"),{
    type:"bar",
    data:{ labels:years, datasets:[
      {label:"Minor",data:minor,stack:"f",borderWidth:0,backgroundColor:"rgba(251,191,36,.85)"},
      {label:"Moderate",data:moderate,stack:"f",borderWidth:0,backgroundColor:"rgba(251,113,133,.80)"},
      {label:"Major",data:major,stack:"f",borderWidth:0,backgroundColor:"rgba(167,139,250,.80)"}
    ]},
    options:{
      responsive:true,maintainAspectRatio:false,
      plugins:{legend:{labels:{color:"rgba(234,240,255,.88)",font:{weight:"950"},boxWidth:16}}},
      scales:{
        x:{stacked:true,ticks:{color:"rgba(169,182,211,.9)",maxRotation:0,autoSkip:true,maxTicksLimit:8},grid:{color:"rgba(255,255,255,.06)"}},
        y:{stacked:true,ticks:{color:"rgba(169,182,211,.9)"},grid:{color:"rgba(255,255,255,.06)"}}
      }
    }
  });
}

/* =========================
   Time series chart
========================= */
let tsChart=null;
function buildTsChart(obs, pred){
  const labels=[...obs.map(p=>p.t), ...pred.map(p=>p.t)];
  const obsData=[...obs.map(p=>p.ft), ...Array(pred.length).fill(null)];
  const predData=[...Array(obs.length).fill(null), ...pred.map(p=>p.ft)];

  if(tsChart) tsChart.destroy();
  tsChart=new Chart($("tsChart"),{
    type:"line",
    data:{ labels, datasets:[
      {label:"Observed (Bivalve)",data:obsData,borderWidth:2,pointRadius:0,tension:.25},
      {label:"Predicted (Cape May)",data:predData,borderWidth:2,pointRadius:0,borderDash:[6,5],tension:.25}
    ]},
    options:{
      responsive:true,maintainAspectRatio:false,
      plugins:{legend:{labels:{color:"rgba(234,240,255,.88)",font:{weight:"950"}}}},
      interaction:{mode:"index",intersect:false},
      scales:{
        x:{
          ticks:{
            color:"rgba(169,182,211,.9)",maxTicksLimit:6,
            callback:(v,i)=>{
              const n=labels.length, step=Math.max(1,Math.floor(n/6));
              return (i%step===0)?fmtNY(labels[i]):"";
            }
          },
          grid:{color:"rgba(255,255,255,.06)"}
        },
        y:{ticks:{color:"rgba(169,182,211,.9)"},grid:{color:"rgba(255,255,255,.06)"}}
      }
    }
  });

  const o=obs.length?`Obs: ${fmtNY(obs[0].t)} → ${fmtNY(obs[obs.length-1].t)}`:"Obs: —";
  const p=pred.length?`Pred: ${fmtNY(pred[0].t)} → ${fmtNY(pred[pred.length-1].t)}`:"Pred: unavailable";
  fcNote.textContent=o+" · "+p;
}

/* =========================
   Historic index: filter + last within ±0.2
========================= */
let HIGH_TIDES=[]; // {t, ft}

function renderHist(rows){
  histBody.innerHTML="";
  const show=rows.slice(0, 80);
  for(const r of show){
    const t=stageTag(r.ft);
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${fmtNY(r.t)}</td>
      <td><b>${r.ft.toFixed(2)}</b></td>
      <td><span class="tag"><span class="chip" style="background:${t.c}"></span>${t.txt}</span></td>
    `;
    histBody.appendChild(tr);
  }
  histMeta.textContent=`Peaks: ${HIGH_TIDES.length.toLocaleString()} · Showing ${Math.min(80, rows.length)} of ${rows.length.toLocaleString()}`;
}

function applyFilter(){
  const min=parseFloat(minElevEl.value);
  const mode=sortModeEl.value;

  let rows=HIGH_TIDES.filter(r=>r.ft>=min);
  if(mode==="desc") rows.sort((a,b)=>b.ft-a.ft);
  if(mode==="asc") rows.sort((a,b)=>a.ft-b.ft);
  if(mode==="recent") rows.sort((a,b)=>new Date(b.t)-new Date(a.t));

  renderHist(rows);
}

function lastWithinDelta(currentFt, nowT){
  if(currentFt < THRESH.moderateLow) return null;
  const delta=0.2, lo=currentFt-delta, hi=currentFt+delta;
  const nowMs=nowT?new Date(nowT).getTime():Date.now();
  let best=null;
  for(const r of HIGH_TIDES){
    const ms=new Date(r.t).getTime();
    if(ms>=nowMs) continue;
    if(r.ft>=lo && r.ft<=hi){
      if(!best || ms>new Date(best.t).getTime()) best=r;
    }
  }
  return best;
}

/* =========================
   Live metrics
========================= */
function setStage(ft){
  const c=classify(ft);
  stageTextEl.textContent=c.label;
  stageDotEl.style.background=c.color;
  stageDotEl.style.boxShadow=`0 0 0 4px ${c.glow}`;
}

async function updateLive(){
  const live=await fetchWithFallback({period:"P3D"}); // enough buffer for “today”
  if(!live.length) throw new Error("no live data");
  const last=live[live.length-1];

  curFtEl.textContent=last.ft.toFixed(2);
  curMetaEl.textContent="Updated: "+fmtNY(last.t);
  setStage(last.ft);

  const monthSeries=await fetchWithFallback({startISO:startOfMonthNY_ISO(), endISO:nowISO()});
  if(monthSeries.length){
    const mx=maxPoint(monthSeries);
    monMaxFtEl.textContent=mx.ft.toFixed(2);
    monMaxMetaEl.textContent="Max @ "+fmtNY(mx.t);
  }else{ monMaxFtEl.textContent="—"; monMaxMetaEl.textContent="—"; }

  const daySeries=await fetchWithFallback({startISO:startOfTodayNY_ISO(), endISO:nowISO()});
  if(daySeries.length){
    const dmx=maxPoint(daySeries), dmn=minPoint(daySeries);
    dayMaxFtEl.textContent=dmx.ft.toFixed(2);
    dayMaxMetaEl.textContent="Max @ "+fmtNY(dmx.t);
    dayMinFtEl.textContent=dmn.ft.toFixed(2);
    dayMinMetaEl.textContent="Min @ "+fmtNY(dmn.t);
  }else{
    dayMaxFtEl.textContent="—"; dayMaxMetaEl.textContent="—";
    dayMinFtEl.textContent="—"; dayMinMetaEl.textContent="—";
  }

  const hit=lastWithinDelta(last.ft, last.t);
  if(hit){
    nearPill.style.display="inline-flex";
    nearChip.style.background=(last.ft>=THRESH.majorLow)?"var(--major)":"var(--moderate)";
    nearText.textContent=`Last within ±0.2 ft: ${hit.ft.toFixed(2)} ft · ${fmtNY(hit.t)}`;
  }else nearPill.style.display="none";

  statusText.textContent="Live updated: "+fmtNY(last.t);
  tsNote.textContent=`Flood stages: Minor ${THRESH.minorLow.toFixed(2)}–${THRESH.moderateLow.toFixed(2)} · Moderate ${THRESH.moderateLow.toFixed(2)}–${THRESH.majorLow.toFixed(2)} · Major ≥ ${THRESH.majorLow.toFixed(2)} ft`;
}

/* =========================
   72h series: obs + NOAA predictions
========================= */
async function updateTimeseries(){
  const end=new Date();
  const start=new Date(end.getTime()-72*3600*1000);
  const obs=await fetchWithFallback({startISO:start.toISOString(), endISO:end.toISOString()});
  let pred=[];
  try{ pred=await fetchNOAA72h(); }catch{ pred=[]; }
  buildTsChart(obs, pred);
}

/* =========================
   Boot
========================= */
async function boot(){
  $("minorBadge").textContent = `${THRESH.minorLow.toFixed(2)}–${THRESH.moderateLow.toFixed(2)}`;
  $("moderateBadge").textContent = `${THRESH.moderateLow.toFixed(2)}–${THRESH.majorLow.toFixed(2)}`;
  $("majorBadge").textContent = `≥ ${THRESH.majorLow.toFixed(2)}`;

  await updateAlerts();

  const [topTen, annual, idx] = await Promise.all([
    loadJSON(TOP_TEN_JSON),
    loadJSON(ANNUAL_COUNTS_JSON),
    loadJSON(HIGH_TIDES_INDEX_JSON)
  ]);

  renderTopTen(Array.isArray(topTen)?topTen:(topTen?.rows||[]));
  renderAnnualChart(Array.isArray(annual)?annual:(annual?.rows||[]));

  HIGH_TIDES=(idx?.peaks||[]).map(p=>({t:p.t, ft:+p.ft})).filter(p=>isNum(p.ft));
  applyFilter();

  await updateLive();
  await updateTimeseries();
}

$("applyBtn").addEventListener("click", applyFilter);
$("resetBtn").addEventListener("click", ()=>{
  minElevEl.value=THRESH.minorLow.toFixed(2);
  sortModeEl.value="desc";
  applyFilter();
});

boot().catch(err=>{
  console.error(err);
  stageTextEl.textContent="LIVE DATA UNAVAILABLE";
  statusText.textContent="—";
  histMeta.textContent="—";
});

// refresh every 5 minutes
setInterval(()=>boot().catch(()=>{}), 5*60*1000);
</script>
</body>
</html>
