<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bivalve, NJ — Tidal Flooding Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1220; --text:#eaf0ff; --muted:#a9b6d3; --line:rgba(255,255,255,.085);
      --ok:#2dd4bf; --minor:#fbbf24; --moderate:#fb7185; --major:#a78bfa;
      --shadow:0 22px 70px rgba(0,0,0,.40); --radius:18px;
      --card:linear-gradient(180deg, rgba(255,255,255,.055), rgba(255,255,255,.025));
      --card2:rgba(0,0,0,.18);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:
        radial-gradient(1200px 650px at 15% -10%, rgba(34,211,238,.18), transparent 55%),
        radial-gradient(1000px 600px at 92% 12%, rgba(167,139,250,.16), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:14px 14px 24px}
    a{color:inherit;text-decoration:none}

    .banner{
      display:none;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(251,113,133,.12);
      border-radius:14px;
      padding:10px 12px;
      margin-bottom:10px;
      box-shadow:var(--shadow);
    }
    .banner b{font-weight:950}
    .banner .small{color:var(--muted);font-size:12.5px;margin-top:4px;line-height:1.25}

    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px}
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{width:44px;height:44px;border-radius:12px;border:1px solid var(--line);background:rgba(0,0,0,.25)}
    .brandTitle{display:flex;flex-direction:column;line-height:1.1}
    .kicker{color:var(--muted);font-weight:850;font-size:12px;letter-spacing:.2px;text-transform:uppercase}
    .name{font-size:18px;font-weight:950;letter-spacing:.2px}

    .pillRow{display:flex;align-items:center;justify-content:flex-end;gap:10px;flex-wrap:wrap}
    .statusPill,.miniPill{
      display:flex;align-items:center;gap:10px;
      padding:9px 12px;border-radius:999px;
      border:1px solid var(--line);background:rgba(0,0,0,.16);
      box-shadow:var(--shadow);
      font-weight:950;font-size:12.5px;white-space:nowrap;
    }
    .dot{width:9px;height:9px;border-radius:999px;background:var(--ok);box-shadow:0 0 0 4px rgba(45,212,191,.16)}

    .grid{
      display:grid;
      grid-template-columns:1.15fr .85fr;
      gap:12px;
      align-items:start;
    }
    @media(max-width:980px){.grid{grid-template-columns:1fr}}

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:12px;
      overflow:hidden;
      position:relative;
    }
    .card:before{
      content:"";position:absolute;inset:-1px;pointer-events:none;opacity:.9;
      background:
        radial-gradient(650px 280px at 16% 0%, rgba(45,212,191,.12), transparent 55%),
        radial-gradient(520px 320px at 90% 18%, rgba(251,113,133,.10), transparent 60%);
    }
    .card>*{position:relative}

    .hrow{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:8px}
    .hrow h2{
      margin:0;font-size:12.5px;letter-spacing:.22px;text-transform:uppercase;color:var(--muted);font-weight:950
    }

    .metrics{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
    @media(max-width:720px){.metrics{grid-template-columns:1fr}}
    .metric{
      background:var(--card2);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      text-align:center;
    }
    .ml{color:var(--muted);font-weight:950;font-size:11.5px;text-transform:uppercase;letter-spacing:.2px;margin-bottom:8px}
    .mv{display:flex;align-items:baseline;justify-content:center;gap:8px;font-weight:950;font-size:28px;letter-spacing:.2px}
    .unit{color:var(--muted);font-size:12px;font-weight:950}
    .ms{margin-top:6px;color:var(--muted);font-size:12.5px;line-height:1.25}

    .splitRow{display:flex;justify-content:center;gap:18px;flex-wrap:wrap}
    .subCap{color:var(--muted);font-weight:950;font-size:11px;letter-spacing:.2px;text-transform:uppercase}
    .bigNum{font-size:28px;font-weight:950;letter-spacing:.2px}

    .stages{
      display:grid;
      grid-template-columns:repeat(3, minmax(0,1fr));
      gap:10px;
      margin-top:10px;
    }
    @media(max-width:760px){.stages{grid-template-columns:1fr}}
    .stage{
      background:var(--card2);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      text-align:center;
    }
    .stageName{font-weight:950;font-size:18px;letter-spacing:.2px;white-space:nowrap}
    .badge{
      font-weight:950;font-size:13px;
      padding:8px 12px;border-radius:999px;
      border:1px solid var(--line);background:rgba(255,255,255,.06);
      white-space:nowrap;
    }

    .table{border-radius:14px;overflow:hidden;border:1px solid var(--line);background:var(--card2)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 10px;border-bottom:1px solid var(--line);font-size:13px}
    th{text-align:left;color:var(--muted);text-transform:uppercase;letter-spacing:.2px;font-size:11px;font-weight:950}
    tr:last-child td{border-bottom:none}
    td.center{text-align:center}

    .tag{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.05);font-weight:950;font-size:12px;white-space:nowrap}
    .chip{width:9px;height:9px;border-radius:99px;display:inline-block}

    .chartWrapTall{height:310px;width:100%}
    .chartWrapSmall{height:220px;width:100%}

    .filterRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    .input,.btn,select{
      background:rgba(0,0,0,.18);border:1px solid var(--line);color:var(--text);
      border-radius:12px;padding:10px 10px;font-weight:950;font-size:13px;outline:none
    }
    .input{min-width:240px}
    .btn{cursor:pointer}
    .btn:hover{filter:brightness(1.06)}
    .hint{color:var(--muted);font-size:12.5px;line-height:1.25}
    .thinNote{margin-top:8px;color:var(--muted);font-size:12.5px;line-height:1.25;text-align:center}
    .centerMsg{padding:12px;text-align:center;color:var(--muted);font-weight:950}
  </style>
</head>

<body>
  <div class="wrap">

    <div class="banner" id="alertBanner">
      <div><b id="alertTitle">Coastal Flood Advisory</b></div>
      <div class="small" id="alertBody"></div>
    </div>

    <div class="top">
      <a class="brand" href="https://cupajoe.live/" target="_blank" rel="noopener">
        <img src="assets/cupajoe-logo.png" alt="Cupajoe logo">
        <div class="brandTitle">
          <div class="kicker">USGS 01412150 · Maurice River at Bivalve, NJ</div>
          <div class="name">Bivalve Tidal Flooding Dashboard</div>
        </div>
      </a>

      <div class="pillRow">
        <div class="miniPill" id="lastUpdatedPill">Last updated: —</div>
        <div class="statusPill">
          <span class="dot" id="stageDot"></span>
          <span id="stageText">Loading…</span>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="hrow">
          <h2>Live conditions</h2>
          <div class="kicker" style="text-transform:none">Times shown in Eastern Time</div>
        </div>

        <div class="metrics">
          <div class="metric">
            <div class="ml">Current water elevation</div>
            <div class="mv"><span id="curFt">—</span><span class="unit">ft</span></div>
            <div class="ms" id="curMeta">—</div>
          </div>

          <div class="metric">
            <div class="ml">Monthly maximum</div>
            <div class="mv"><span id="monMaxFt">—</span><span class="unit">ft</span></div>
            <div class="ms" id="monMaxMeta">—</div>
          </div>

          <div class="metric" style="grid-column:1 / -1">
            <div class="ml">Daily range (today)</div>
            <div class="splitRow">
              <div><div class="subCap">Max</div><span class="bigNum" id="dayMaxFt">—</span> <span class="unit">ft</span></div>
              <div><div class="subCap">Min</div><span class="bigNum" id="dayMinFt">—</span> <span class="unit">ft</span></div>
            </div>
            <div class="ms" id="dayRangeMeta">—</div>
          </div>
        </div>

        <div class="stages" aria-label="Flood stages">
          <div class="stage"><div class="stageName">Minor</div><div class="badge" style="color:var(--minor)">4.19–5.19</div></div>
          <div class="stage"><div class="stageName">Moderate</div><div class="badge" style="color:var(--moderate)">5.19–6.19</div></div>
          <div class="stage"><div class="stageName">Major</div><div class="badge" style="color:var(--major)">≥ 6.19</div></div>
        </div>

        <div style="height:10px"></div>
        <div class="hrow"><h2>Annual flooding (2000–present)</h2></div>
        <div class="chartWrapSmall"><canvas id="annualChart"></canvas></div>
        <div class="thinNote">Note: sparse data in 2000–2002.</div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="hrow"><h2>Top ten highest tides</h2></div>
        <div class="table">
          <table aria-label="Top ten highest tides">
            <thead>
              <tr>
                <th>Rank</th>
                <th>Date</th>
                <th class="center">Height</th>
                <th class="center">Type</th>
              </tr>
            </thead>
            <tbody id="topTenBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div style="height:12px"></div>

    <div class="card">
      <div class="hrow">
        <h2>72 hours: observations vs Cape May predictions (NAVD88)</h2>
        <div class="kicker" style="text-transform:none">Observed: USGS 15-min · Predicted: NOAA CO-OPS</div>
      </div>
      <div class="chartWrapTall"><canvas id="tsChart"></canvas></div>
      <div class="thinNote" id="fcNote">—</div>
    </div>

    <div style="height:12px"></div>

    <div class="card">
      <div class="hrow"><h2>Historic tides filter (all 15-min readings)</h2></div>

      <div class="filterRow">
        <input class="input" id="minElev" type="number" step="0.01" value="4.19" />
        <select id="sortMode">
          <option value="desc">Highest first</option>
          <option value="asc">Lowest first</option>
          <option value="recent">Most recent</option>
        </select>
        <button class="btn" id="applyBtn">Apply</button>
        <button class="btn" id="resetBtn">Reset</button>
      </div>

      <div class="hint" id="histMeta">Loading…</div>

      <div style="height:10px"></div>

      <div class="table" id="histTableWrap">
        <table aria-label="Historic 15-min readings above threshold">
          <thead>
            <tr>
              <th>Date/Time (ET)</th>
              <th class="center">Level</th>
              <th class="center">Type</th>
            </tr>
          </thead>
          <tbody id="histBody"></tbody>
        </table>
      </div>

      <div class="centerMsg" id="histEmpty" style="display:none">—</div>
    </div>

  </div>

<script>
/* ===== CONFIG ===== */
const TZ="America/New_York";
const USGS_SITE="01412150";
const PRIMARY_PARAM="72279";
const FALLBACK_PARAM="00065";
const THRESH={minorLow:4.19, moderateLow:5.19, majorLow:6.19};
const ALERT_POINT={lat:39.2325, lon:-75.0380};

const NOAA_STATION="8536110";
const MLLW_TO_NAVD88=-2.77;

/* Historic all-tides query settings */
const HIST_START_ISO="1900-01-01T00:00:00Z";
const HIST_FALLBACK_DAYS=[3650, 1825, 1095, 730, 365]; // 10y,5y,3y,2y,1y
const MAX_STORE=120000;
const MAX_RENDER=120;
const HIST_SAMPLE_STRIDE=1;

/* Top ten */
const TOP_TEN=[
  {date:"10-29-2012", ft:7.03},
  {date:"11-25-1950", ft:6.60},
  {date:"04-16-2011", ft:5.80},
  {date:"08-04-2020", ft:5.67},
  {date:"08-27-2011", ft:5.60},
  {date:"01-23-2016", ft:5.58},
  {date:"04-19-2022", ft:5.50},
  {date:"08-21-????", ft:5.49},
  {date:"10-26-2019", ft:5.41},
  {date:"03-09-2024", ft:5.39}
];

/* Annual */
const START_YEAR=2000;
const providedMinor=[0,0,1,20,13,25,19,16,20,29,25,30,23,20,23,11,23,34,40,44,35,31,14,41,65,38];
const providedModerate=[0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,2,0,2,0,1,0,1,0,3,1];
const providedMajor=providedMinor.map(()=>0);

/* ===== DOM ===== */
const $=id=>document.getElementById(id);
const curFtEl=$("curFt"), curMetaEl=$("curMeta");
const monMaxFtEl=$("monMaxFt"), monMaxMetaEl=$("monMaxMeta");
const dayMaxFtEl=$("dayMaxFt"), dayMinFtEl=$("dayMinFt"), dayRangeMetaEl=$("dayRangeMeta");
const stageTextEl=$("stageText"), stageDotEl=$("stageDot");
const lastUpdatedPill=$("lastUpdatedPill");
const alertBanner=$("alertBanner"), alertTitle=$("alertTitle"), alertBody=$("alertBody");
const topTenBody=$("topTenBody");
const histBody=$("histBody"), histMeta=$("histMeta");
const histTableWrap=$("histTableWrap"), histEmpty=$("histEmpty");
const minElevEl=$("minElev"), sortModeEl=$("sortMode");
const fcNote=$("fcNote");

/* ===== TIME (ET) ===== */
const dtfET = new Intl.DateTimeFormat("en-US",{
  timeZone:TZ, year:"numeric", month:"short", day:"2-digit",
  hour:"2-digit", minute:"2-digit"
});
const dtfYMD = new Intl.DateTimeFormat("en-CA",{ timeZone:TZ, year:"numeric", month:"2-digit", day:"2-digit" });
function normalizeISO(s){
  if(!s) return s;
  let t=String(s).trim();
  if(t.includes(" ")) t=t.replace(" ","T");
  if(!/[zZ]$/.test(t) && !/[+-]\d\d:\d\d$/.test(t)) t += "Z";
  return t;
}
const fmtET=iso=>{ try{return dtfET.format(new Date(normalizeISO(iso)));}catch{return iso;} };
const nowISO=()=>new Date().toISOString();
function getNYParts(date=new Date()){
  const p=dtfYMD.formatToParts(date);
  return { y:+p.find(x=>x.type==="year").value, m:+p.find(x=>x.type==="month").value, d:+p.find(x=>x.type==="day").value };
}
function startOfTodayNY_ISO(){ const {y,m,d}=getNYParts(); return new Date(Date.UTC(y,m-1,d,0,0,0)).toISOString(); }
function startOfMonthNY_ISO(){ const {y,m}=getNYParts(); return new Date(Date.UTC(y,m-1,1,0,0,0)).toISOString(); }

/* ===== STAGE ===== */
function classify(ft){
  if(ft>=THRESH.majorLow) return {label:"MAJOR FLOODING", c:"var(--major)", g:"rgba(167,139,250,.22)", s:"Major"};
  if(ft>=THRESH.moderateLow) return {label:"MODERATE FLOODING", c:"var(--moderate)", g:"rgba(251,113,133,.22)", s:"Moderate"};
  if(ft>=THRESH.minorLow) return {label:"MINOR FLOODING", c:"var(--minor)", g:"rgba(251,191,36,.22)", s:"Minor"};
  return {label:"BELOW FLOOD STAGE", c:"var(--ok)", g:"rgba(45,212,191,.18)", s:"Below"};
}
const maxPoint=arr=>arr.reduce((a,b)=>b.ft>a.ft?b:a, arr[0]);
const minPoint=arr=>arr.reduce((a,b)=>b.ft<a.ft?b:a, arr[0]);

/* ===== USGS ===== */
async function fetchIV({startISO=null,endISO=null,parameterCd=PRIMARY_PARAM,period=null}={}){
  const u=new URL("https://waterservices.usgs.gov/nwis/iv/");
  u.searchParams.set("format","json");
  u.searchParams.set("sites",USGS_SITE);
  u.searchParams.set("parameterCd",parameterCd);
  u.searchParams.set("siteStatus","all");
  u.searchParams.set("agencyCd","USGS");
  if(period) u.searchParams.set("period",period);
  if(startISO) u.searchParams.set("startDT",startISO);
  if(endISO) u.searchParams.set("endDT",endISO);
  const r=await fetch(u.toString(),{cache:"no-store"});
  if(!r.ok) throw new Error("USGS IV "+r.status);
  return r.json();
}
function extractSeries(j){
  const vals=j?.value?.timeSeries?.[0]?.values?.[0]?.value||[];
  return vals.map(v=>({t:v.dateTime, ft:+v.value})).filter(p=>p.t && Number.isFinite(p.ft));
}
async function fetchWithFallback(opts){
  let s=extractSeries(await fetchIV({...opts,parameterCd:PRIMARY_PARAM}));
  if(s.length) return s;
  return extractSeries(await fetchIV({...opts,parameterCd:FALLBACK_PARAM}));
}

/* ===== NOAA predictions (MLLW -> NAVD88) =====
   FIX:
   - Use begin_date/end_date WITH TIME (UTC) so predictions start near "now", not 00:00 UTC.
*/
function pad2(n){return String(n).padStart(2,"0");}
function ymdhmUTC(d){
  return (
    d.getUTCFullYear() +
    pad2(d.getUTCMonth()+1) +
    pad2(d.getUTCDate()) + " " +
    pad2(d.getUTCHours()) + ":" +
    pad2(d.getUTCMinutes())
  );
}
function roundToMinutesUTC(d, step){
  const ms=d.getTime();
  const m=step*60*1000;
  return new Date(Math.floor(ms/m)*m);
}
async function fetchNOAA72h_NAVD88(beginUTC){
  const base="https://api.tidesandcurrents.noaa.gov/api/prod/datagetter";
  const begin = roundToMinutesUTC(beginUTC ?? new Date(), 6); // align to 6-min grid
  const end = new Date(begin.getTime()+72*3600*1000);

  const qs=new URLSearchParams({
    product:"predictions",
    application:"cupajoe",
    station:NOAA_STATION,
    begin_date: ymdhmUTC(begin),    // <-- timestamp
    end_date:   ymdhmUTC(end),      // <-- timestamp
    time_zone:"gmt",
    units:"english",
    interval:"6",
    format:"json",
    datum:"MLLW"
  });

  const r=await fetch(base+"?"+qs.toString(),{cache:"no-store"});
  if(!r.ok) throw new Error("NOAA "+r.status);
  const j=await r.json();

  return (j?.predictions||[])
    .map(p=>{
      const t=(p.t.includes("T")?p.t:p.t.replace(" ","T"))+"Z"; // UTC
      return {t, ft:(+p.v)+MLLW_TO_NAVD88};
    })
    .filter(p=>p.t && Number.isFinite(p.ft));
}

/* ===== NWS banner ===== */
async function updateAlerts(){
  try{
    const r=await fetch(`https://api.weather.gov/alerts/active?point=${ALERT_POINT.lat},${ALERT_POINT.lon}`,{cache:"no-store"});
    if(!r.ok) throw new Error();
    const j=await r.json();
    const c=(j?.features||[]).find(f=>((f?.properties?.event||"").toLowerCase().includes("coastal flood")));
    if(!c){ alertBanner.style.display="none"; return; }
    const p=c.properties||{};
    alertTitle.textContent=p.event||"Coastal Flood Alert";
    const ends=p.ends?fmtET(p.ends):(p.expires?fmtET(p.expires):"—");
    alertBody.textContent=(p.headline?p.headline+" · ":"")+"Ends: "+ends;
    alertBanner.style.display="block";
  }catch{ alertBanner.style.display="none"; }
}

/* ===== Top ten ===== */
function renderTopTen(){
  topTenBody.innerHTML="";
  TOP_TEN.forEach((r,i)=>{
    const t=classify(r.ft);
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><b>#${i+1}</b></td>
      <td>${r.date}</td>
      <td class="center"><b>${r.ft.toFixed(2)}</b></td>
      <td class="center"><span class="tag"><span class="chip" style="background:${t.c}"></span>${t.s}</span></td>
    `;
    topTenBody.appendChild(tr);
  });
}

/* ===== Annual chart ===== */
let annualChart=null;
function buildAnnualRows(){
  const nowY=new Date().getFullYear();
  const rows=[];
  for(let y=START_YEAR;y<=nowY;y++){
    const i=y-START_YEAR;
    rows.push({
      y,
      minor:(i>=0&&i<providedMinor.length)?(providedMinor[i]||0):0,
      moderate:(i>=0&&i<providedModerate.length)?(providedModerate[i]||0):0,
      major:(i>=0&&i<providedMajor.length)?(providedMajor[i]||0):0
    });
  }
  return rows;
}
function renderAnnualChart(rows){
  if(annualChart) annualChart.destroy();
  annualChart=new Chart($("annualChart"),{
    type:"bar",
    data:{
      labels:rows.map(r=>r.y),
      datasets:[
        {label:"Minor",data:rows.map(r=>r.minor),stack:"f",borderWidth:0,backgroundColor:"rgba(251,191,36,.85)"},
        {label:"Moderate",data:rows.map(r=>r.moderate),stack:"f",borderWidth:0,backgroundColor:"rgba(251,113,133,.80)"},
        {label:"Major",data:rows.map(r=>r.major),stack:"f",borderWidth:0,backgroundColor:"rgba(167,139,250,.80)"}
      ]
    },
    options:{
      responsive:true,maintainAspectRatio:false,
      plugins:{legend:{labels:{color:"rgba(234,240,255,.88)",font:{weight:"950"},boxWidth:16}}},
      scales:{
        x:{stacked:true,ticks:{color:"rgba(169,182,211,.9)",autoSkip:true,maxTicksLimit:6,maxRotation:0},grid:{color:"rgba(255,255,255,.06)"}},
        y:{stacked:true,ticks:{color:"rgba(169,182,211,.9)",precision:0},grid:{color:"rgba(255,255,255,.06)"}}
      }
    }
  });
}

/* ===== 72h chart =====
   FIX:
   - Use a true numeric time axis (ms since epoch)
   - Predictions trimmed so they begin AFTER last observation timestamp
*/
let tsChart=null;
function toMs(iso){ return Date.parse(normalizeISO(iso)); }

function buildTsChart(obs, fc){
  const obsPts = obs.map(p=>({x:toMs(p.t), y:p.ft})).filter(p=>Number.isFinite(p.x)&&Number.isFinite(p.y));
  const fcPts  = fc.map(p=>({x:toMs(p.t), y:p.ft})).filter(p=>Number.isFinite(p.x)&&Number.isFinite(p.y));

  if(tsChart) tsChart.destroy();
  tsChart=new Chart($("tsChart"),{
    type:"line",
    data:{
      datasets:[
        {label:"Observed (USGS)", data:obsPts, borderWidth:2, pointRadius:0, tension:.25},
        {label:"Predicted (Cape May, NAVD88)", data:fcPts, borderWidth:2, pointRadius:0, borderDash:[6,5], tension:.25}
      ]
    },
    options:{
      responsive:true,maintainAspectRatio:false,
      plugins:{
        legend:{labels:{color:"rgba(234,240,255,.88)",font:{weight:"950"}}},
        tooltip:{
          callbacks:{
            title:(items)=> items?.[0]?.parsed?.x ? fmtET(new Date(items[0].parsed.x).toISOString()) : ""
          }
        }
      },
      interaction:{mode:"index",intersect:false},
      parsing:false,
      scales:{
        x:{
          type:"linear",
          ticks:{
            color:"rgba(169,182,211,.9)",
            maxTicksLimit:7,
            callback:(v)=> fmtET(new Date(v).toISOString())
          },
          grid:{color:"rgba(255,255,255,.06)"}
        },
        y:{ticks:{color:"rgba(169,182,211,.9)"},grid:{color:"rgba(255,255,255,.06)"}}
      }
    }
  });

  const obsMsg=obs.length?`Obs: ${fmtET(obs[0].t)} → ${fmtET(obs[obs.length-1].t)}`:"Obs: —";
  const fcMsg=fc.length?`Pred: ${fmtET(fc[0].t)} → ${fmtET(fc[fc.length-1].t)}`:"Pred: unavailable";
  fcNote.textContent=obsMsg+" · "+fcMsg;
}

/* ===== Historic ALL tides filter ===== */
let HIST_SERIES=[];
function compactSeries(series){
  if(series.length<=MAX_STORE) return series;
  const stride=Math.ceil(series.length / MAX_STORE);
  const out=[];
  for(let i=0;i<series.length;i+=stride) out.push(series[i]);
  return out;
}
async function fetchHistoricAllTides(){
  const end=nowISO();
  const tryFetch = async (startISO)=> fetchWithFallback({startISO, endISO:end});
  try{ const big=await tryFetch(HIST_START_ISO); if(big.length) return big; }catch{}
  for(const days of HIST_FALLBACK_DAYS){
    try{
      const start=new Date(Date.now()-days*86400*1000).toISOString();
      const s=await tryFetch(start);
      if(s.length) return s;
    }catch{}
  }
  return [];
}
function renderHist(rows){
  histBody.innerHTML="";
  const show=rows.slice(0,MAX_RENDER);
  for(const r of show){
    const t=classify(r.ft);
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${fmtET(r.t)}</td>
      <td class="center"><b>${r.ft.toFixed(2)}</b></td>
      <td class="center"><span class="tag"><span class="chip" style="background:${t.c}"></span>${t.s}</span></td>
    `;
    histBody.appendChild(tr);
  }
  histMeta.textContent=`Loaded readings: ${HIST_SERIES.length.toLocaleString()} · Showing ${Math.min(MAX_RENDER, rows.length)} of ${rows.length.toLocaleString()}`;
}
function applyHistFilter(){
  if(!HIST_SERIES.length){ histMeta.textContent="Historic tides unavailable."; return; }
  const min=+minElevEl.value || THRESH.minorLow;
  const mode=sortModeEl.value;
  let rows=HIST_SERIES.filter(r=>r.ft>=min);
  if(mode==="desc") rows.sort((a,b)=>b.ft-a.ft);
  if(mode==="asc") rows.sort((a,b)=>a.ft-b.ft);
  if(mode==="recent") rows.sort((a,b)=>new Date(b.t)-new Date(a.t));
  renderHist(rows);
}

/* ===== Live metrics ===== */
function setStage(ft){
  const s=classify(ft);
  stageTextEl.textContent=s.label;
  stageDotEl.style.background=s.c;
  stageDotEl.style.boxShadow=`0 0 0 4px ${s.g}`;
}
async function updateLive(){
  const nowSeries=await fetchWithFallback({period:"P3D"});
  if(!nowSeries.length) throw new Error("no live data");
  const last=nowSeries[nowSeries.length-1];

  curFtEl.textContent=last.ft.toFixed(2);
  curMetaEl.textContent="Updated: "+fmtET(last.t);
  lastUpdatedPill.textContent="Last updated: "+fmtET(last.t);
  setStage(last.ft);

  const monthSeries=await fetchWithFallback({startISO:startOfMonthNY_ISO(), endISO:nowISO()});
  if(monthSeries.length){
    const mx=maxPoint(monthSeries);
    monMaxFtEl.textContent=mx.ft.toFixed(2);
    monMaxMetaEl.textContent="Max @ "+fmtET(mx.t);
  }else{
    monMaxFtEl.textContent="—";
    monMaxMetaEl.textContent="—";
  }

  const daySeries=await fetchWithFallback({startISO:startOfTodayNY_ISO(), endISO:nowISO()});
  if(daySeries.length){
    const dmx=maxPoint(daySeries), dmn=minPoint(daySeries);
    dayMaxFtEl.textContent=dmx.ft.toFixed(2);
    dayMinFtEl.textContent=dmn.ft.toFixed(2);
    dayRangeMetaEl.textContent=`Max @ ${fmtET(dmx.t)} · Min @ ${fmtET(dmn.t)}`;
  }else{
    dayMaxFtEl.textContent="—"; dayMinFtEl.textContent="—"; dayRangeMetaEl.textContent="—";
  }

  return last; // return latest obs point
}

async function updateTimeseries(latestObs){
  const end=new Date(), start=new Date(end.getTime()-72*3600*1000);
  const obs=await fetchWithFallback({startISO:start.toISOString(), endISO:end.toISOString()});

  // anchor predictions to "now" but also ensure they begin AFTER last obs timestamp
  const obsLast = latestObs?.t ? new Date(normalizeISO(latestObs.t)) : (obs.length ? new Date(normalizeISO(obs[obs.length-1].t)) : new Date());
  let fc=[];
  try{
    fc=await fetchNOAA72h_NAVD88(new Date()); // start at current UTC time (rounded)
  }catch{ fc=[]; }

  const cutoff = obsLast.getTime();
  fc = fc.filter(p=> toMs(p.t) >= cutoff);

  buildTsChart(obs, fc);
}

/* ===== Boot ===== */
async function boot(){
  renderTopTen();
  updateAlerts();
  renderAnnualChart(buildAnnualRows());

  // Historic all-tides (unchanged)
  histMeta.textContent="Loading historic 15-min readings…";
  histEmpty.style.display="none";
  histTableWrap.style.display="block";
  fetchHistoricAllTides().then(series=>{
    if(!series.length) throw new Error("no historic data returned");
    const sampled = (HIST_SAMPLE_STRIDE>1) ? series.filter((_,i)=>i%HIST_SAMPLE_STRIDE===0) : series;
    HIST_SERIES = compactSeries(sampled);
    HIST_SERIES.sort((a,b)=>new Date(b.t)-new Date(a.t));
    applyHistFilter();
  }).catch(e=>{
    console.error(e);
    HIST_SERIES=[];
    histBody.innerHTML="";
    histTableWrap.style.display="none";
    histEmpty.style.display="block";
    histEmpty.textContent="Historic tides unavailable (USGS long-range query may be limited).";
    histMeta.textContent="—";
  });

  try{
    const latestObs = await updateLive();
    await updateTimeseries(latestObs);
  }catch(e){
    console.error(e);
    stageTextEl.textContent="LIVE DATA UNAVAILABLE";
    lastUpdatedPill.textContent="Last updated: —";
  }
}

$("applyBtn").addEventListener("click", applyHistFilter);
$("resetBtn").addEventListener("click", ()=>{
  minElevEl.value=THRESH.minorLow.toFixed(2);
  sortModeEl.value="desc";
  applyHistFilter();
});

boot();
setInterval(()=>boot(), 5*60*1000);
</script>
</body>
</html>
