<!-- =========================
PART A / 2 — index.html
PASTE THIS FIRST. PART B CONTINUES AFTER THIS.
========================= -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bivalve, NJ — Tidal Flooding Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --text:#eaf0ff;
      --muted:#a9b6d3;
      --line:rgba(255,255,255,.085);
      --ok:#2dd4bf;
      --minor:#fbbf24;
      --moderate:#fb7185;
      --major:#a78bfa;
      --shadow:0 22px 70px rgba(0,0,0,.40);
      --radius:18px;
      --card:linear-gradient(180deg, rgba(255,255,255,.055), rgba(255,255,255,.025));
      --card2:rgba(0,0,0,.18);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:
        radial-gradient(1200px 650px at 15% -10%, rgba(34,211,238,.18), transparent 55%),
        radial-gradient(1000px 600px at 92% 12%, rgba(167,139,250,.16), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:14px}
    .chartWrapTall{height:320px}
    .btn{background:#00000033;border:1px solid var(--line);color:#fff;padding:10px;border-radius:12px;font-weight:900;cursor:pointer}
  </style>
</head>

<body>
<div class="wrap">

  <button class="btn" id="datumBtn">Datum: MLLW</button>

  <div class="card">
    <div class="chartWrapTall">
      <canvas id="tideChart"></canvas>
    </div>
  </div>

</div>

<script>
"use strict";

/* =============================
CONFIG
============================= */

const TZ = "Etc/GMT+5";
let DISPLAY_DATUM = "MLLW";

const OFFSET_NAVD_FROM_MLLW_FT = 3.41;
const USGS_SITE = "01412150";
const USGS_PARAM = "72279";
const COOPS_STATION = "8536110";

const THRESH_NAVD_MINOR = 4.19;
const THRESH_NAVD_MODERATE = 5.19;
const THRESH_NAVD_MAJOR = 6.19;

/* =============================
HELPERS
============================= */

function mllwToNavd(v){ return v + OFFSET_NAVD_FROM_MLLW_FT; }
function navdToMllw(v){ return v - OFFSET_NAVD_FROM_MLLW_FT; }

function displayFromNavd(v){
  return DISPLAY_DATUM === "NAVD88" ? v : navdToMllw(v);
}

function thresholdForDisplay(kind){
  const navd =
    kind==="minor" ? THRESH_NAVD_MINOR :
    kind==="moderate" ? THRESH_NAVD_MODERATE :
    THRESH_NAVD_MAJOR;
  return displayFromNavd(navd);
}

async function fetchJSON(url){
  const r = await fetch(url,{cache:"no-store"});
  if(!r.ok) throw new Error("HTTP "+r.status);
  return r.json();
}

/* =============================
DATA LOADERS
============================= */

async function loadObserved24h(){
  const end = new Date();
  const start = new Date(end.getTime() - 24*3600*1000);

  const url =
    `https://waterservices.usgs.gov/nwis/iv/?format=json` +
    `&sites=${USGS_SITE}` +
    `&parameterCd=${USGS_PARAM}` +
    `&startDT=${start.toISOString()}` +
    `&endDT=${end.toISOString()}`;

  const json = await fetchJSON(url);
  return json.value.timeSeries[0].values[0].value.map(v=>({
    x:new Date(v.dateTime).getTime(),
    y:displayFromNavd(+v.value)
  }));
}

async function loadPredicted72h(){
  const now = new Date();
  const end = new Date(now.getTime() + 72*3600*1000);

  const pad = n=>String(n).padStart(2,"0");
  const fmt = d=>`${d.getUTCFullYear()}-${pad(d.getUTCMonth()+1)}-${pad(d.getUTCDate())} ${pad(d.getUTCHours())}:${pad(d.getUTCMinutes())}`;

  const url =
    `https://api.tidesandcurrents.noaa.gov/api/prod/datagetter` +
    `?product=predictions&datum=MLLW&station=${COOPS_STATION}` +
    `&begin_date=${fmt(now)}&end_date=${fmt(end)}` +
    `&time_zone=gmt&units=english&interval=6&format=json`;

  const json = await fetchJSON(url);
  return json.predictions.map(p=>({
    x:new Date(p.t+"Z").getTime(),
    y:displayFromNavd(mllwToNavd(+p.v))
  }));
}

/* =============================
CHART + NOAA FLOOD OVERLAY
============================= */

let tideChart = null;

const floodOverlayPlugin = {
  id:"floodOverlay",
  beforeDatasetsDraw(chart,args,opts){
    const y = chart.scales.y;
    const a = chart.chartArea;
    const ctx = chart.ctx;

    const draw=(v,color)=>{
      const py = y.getPixelForValue(v);
      ctx.save();
      ctx.strokeStyle=color;
      ctx.setLineDash([6,4]);
      ctx.beginPath();
      ctx.moveTo(a.left,py);
      ctx.lineTo(a.right,py);
      ctx.stroke();
      ctx.restore();
    };

    draw(opts.minor,getComputedStyle(document.documentElement).getPropertyValue("--minor"));
    draw(opts.moderate,getComputedStyle(document.documentElement).getPropertyValue("--moderate"));
    draw(opts.major,getComputedStyle(document.documentElement).getPropertyValue("--major"));
  }
};

function ensureChart(){
  if(tideChart) return tideChart;

  tideChart = new Chart(
    document.getElementById("tideChart"),
    {
      type:"line",
      data:{datasets:[
        {label:"Observed",data:[],borderColor:"#2dd4bf",pointRadius:0},
        {label:"Predicted",data:[],borderColor:"#94a3b8",borderDash:[5,4],pointRadius:0}
      ]},
      options:{
        animation:false,
        parsing:false,
        scales:{x:{type:"time"},y:{}},
        plugins:{
          legend:{display:false},
          floodOverlay:{
            minor:thresholdForDisplay("minor"),
            moderate:thresholdForDisplay("moderate"),
            major:thresholdForDisplay("major")
          }
        }
      },
      plugins:[floodOverlayPlugin]
    }
  );

  return tideChart;
}
/* =============================
RENDER + UPDATE
============================= */

async function updateAll(){
  try{
    const [obs, pred] = await Promise.all([
      loadObserved24h(),
      loadPredicted72h()
    ]);

    const chart = ensureChart();

    chart.data.datasets[0].data = obs;
    chart.data.datasets[1].data = pred;

    chart.options.plugins.floodOverlay.minor = thresholdForDisplay("minor");
    chart.options.plugins.floodOverlay.moderate = thresholdForDisplay("moderate");
    chart.options.plugins.floodOverlay.major = thresholdForDisplay("major");

    const ys = [...obs, ...pred].map(d=>d.y).filter(v=>isFinite(v));
    if(ys.length){
      chart.options.scales.y.min = Math.min(...ys) - 0.4;
      chart.options.scales.y.max = Math.max(...ys) + 0.4;
    }

    chart.update("none");
  } catch(err){
    console.error(err);
  }
}

/* =============================
DATUM TOGGLE
============================= */

document.getElementById("datumBtn").addEventListener("click",()=>{
  DISPLAY_DATUM = DISPLAY_DATUM==="MLLW" ? "NAVD88" : "MLLW";
  document.getElementById("datumBtn").textContent =
    "Datum: " + (DISPLAY_DATUM==="NAVD88" ? "NAVD88" : "MLLW");
  updateAll();
});

/* =============================
BOOT
============================= */

ensureChart();
updateAll();
setInterval(updateAll, 5 * 60 * 1000);

</script>
</body>
</html>
